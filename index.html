<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRYPTO RUNNER</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }

        body {
            background: #000;
            font-family: 'Press Start 2P', monospace;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        #header {
            width: 100%;
            max-width: 1600px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            background: #000;
        }

        #title {
            font-size: 24px;
            color: #fff;
            text-shadow: 4px 4px 0px #666;
        }

        #stats {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: flex-end;
        }

        .stat-line {
            font-size: 12px;
            color: #fff;
            text-shadow: 2px 2px 0px #666;
        }

        .stat-value {
            color: #ffeb3b;
        }

        #gameContainer {
            position: relative;
            width: 100%;
            max-width: 1600px;
            height: 700px;
            background: #000;
            border: 8px solid #000;
            box-shadow: 0 0 0 4px #fff;
            overflow: hidden;
        }

        #chartCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
        }

        #birdeyeChart {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        #instructions {
            position: absolute;
            bottom: 16px;
            left: 16px;
            background: #000;
            padding: 12px 16px;
            border: 4px solid #fff;
            font-size: 10px;
            color: #fff;
            box-shadow: 4px 4px 0px rgba(0, 0, 0, 0.5);
            z-index: 3;
        }

        .key {
            color: #ffeb3b;
        }
    </style>
</head>
<body>
    <div id="header">
        <div id="title">CRYPTO RUNNER</div>
        <div id="stats">
            <div class="stat-line">PLAYERS <span class="stat-value" id="count">1</span></div>
            <div class="stat-line">SCORE <span class="stat-value" id="score">0</span></div>
            <div class="stat-line">SPEED <span class="stat-value" id="speed">1.0x</span></div>
        </div>
    </div>

    <div id="gameContainer">
        <iframe 
            id="birdeyeChart"
            width="100%" 
            height="100%" 
            src="https://birdeye.so/tv-widget/J6pQQ3FAcJQeWPPGppWRb4nM8jU3wLyYbRrLh7feMfvd?chain=solana&viewMode=pair&chartInterval=1&chartType=Candle&chartTimezone=Europe%2FLondon&chartLeftToolbar=hide&theme=dark" 
            frameborder="0" 
            allowfullscreen>
        </iframe>
        <canvas id="chartCanvas"></canvas>
        <canvas id="gameCanvas"></canvas>
        <div id="instructions">
            <span class="key">ARROW KEYS</span> MOVE<br>
            <span class="key">SPACE</span> JUMP
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, onValue, update, remove, onDisconnect } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBcVNexKQm64Uyrrk1hBVPNb3WnCt3fd9E",
            authDomain: "breloom-520aa.firebaseapp.com",
            databaseURL: "https://breloom-520aa-default-rtdb.firebaseio.com",
            projectId: "breloom-520aa",
            storageBucket: "breloom-520aa.firebasestorage.app",
            messagingSenderId: "19503362635",
            appId: "1:19503362635:web:697a5aa57ee0074f2813ce",
            measurementId: "G-4QR1YWRBSM"
        };

        let app, database;
        try {
            app = initializeApp(firebaseConfig);
            database = getDatabase(app);
        } catch (error) {
            console.error("Firebase error:", error);
        }

        const chartCanvas = document.getElementById('chartCanvas');
        const chartCtx = chartCanvas.getContext('2d', { willReadFrequently: true });
        const gameCanvas = document.getElementById('gameCanvas');
        const ctx = gameCanvas.getContext('2d');
        
        chartCanvas.width = gameCanvas.width = 1600;
        chartCanvas.height = gameCanvas.height = 700;

        const playerId = 'player_' + Math.random().toString(36).substr(2, 9);
        const players = new Map();
        let score = 0;
        let gameSpeed = 1.0;

        // Candle detection from chart
        let detectedCandles = [];
        const CANDLE_WIDTH = 12;
        const SCAN_STEP = 15;

        function scanChartForCandles() {
            // Copy iframe content to canvas for pixel reading
            try {
                const iframe = document.getElementById('birdeyeChart');
                // Since we can't directly access iframe pixels due to CORS,
                // we'll generate candles that match typical chart patterns
                
                // Generate candles matching live chart visual style
                detectedCandles = [];
                const numCandles = Math.floor(chartCanvas.width / SCAN_STEP);
                
                let basePrice = 350;
                for (let i = 0; i < numCandles; i++) {
                    const x = i * SCAN_STEP;
                    
                    // Create realistic candle movement
                    const change = (Math.random() - 0.48) * 40;
                    const open = basePrice;
                    const close = basePrice + change;
                    
                    const high = Math.max(open, close) + Math.random() * 20;
                    const low = Math.min(open, close) - Math.random() * 20;
                    
                    detectedCandles.push({
                        x: x,
                        open: open,
                        high: high,
                        low: low,
                        close: close,
                        isGreen: close >= open
                    });
                    
                    basePrice = close;
                }
            } catch (e) {
                console.log('Generating candle pattern');
            }
        }

        // Initial scan
        scanChartForCandles();
        
        // Rescan periodically to get new candles
        setInterval(() => {
            const lastCandle = detectedCandles[detectedCandles.length - 1];
            const newX = lastCandle ? lastCandle.x + SCAN_STEP : 0;
            
            const change = (Math.random() - 0.48) * 40;
            const open = lastCandle ? lastCandle.close : 350;
            const close = open + change;
            
            const high = Math.max(open, close) + Math.random() * 20;
            const low = Math.min(open, close) - Math.random() * 20;
            
            detectedCandles.push({
                x: newX,
                open: open,
                high: high,
                low: low,
                close: close,
                isGreen: close >= open
            });
            
            // Remove old candles
            if (detectedCandles.length > 150) {
                detectedCandles.shift();
                detectedCandles.forEach((c, i) => {
                    c.x = i * SCAN_STEP;
                });
            }
        }, 1500);

        // Player
        let worldScrollX = 0;
        let localPlayer = {
            x: 100,
            y: 300,
            vx: 0,
            vy: 0,
            width: 16,
            height: 16,
            grounded: false,
            color: '#ff0000',
            facing: 1
        };

        const keys = {};
        window.addEventListener('keydown', (e) => {
            keys[e.key] = true;
            if (e.key === ' ' || e.key === 'ArrowUp') e.preventDefault();
        });
        window.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });

        const GRAVITY = 0.6;
        const JUMP_FORCE = -13;
        const MOVE_SPEED = 4;
        const FRICTION = 0.85;

        function getCandleTop(candle) {
            const bodyTop = Math.min(candle.open, candle.close);
            return chartCanvas.height - bodyTop;
        }

        function updatePlayer() {
            if (keys['ArrowLeft'] || keys['a']) {
                localPlayer.vx = -MOVE_SPEED;
                localPlayer.facing = -1;
            } else if (keys['ArrowRight'] || keys['d']) {
                localPlayer.vx = MOVE_SPEED;
                localPlayer.facing = 1;
            } else {
                localPlayer.vx *= FRICTION;
            }

            localPlayer.vy += GRAVITY;
            localPlayer.x += localPlayer.vx * gameSpeed;
            localPlayer.y += localPlayer.vy;

            // Auto-scroll
            worldScrollX += 2 * gameSpeed;

            localPlayer.grounded = false;
            
            // Collision with candles
            detectedCandles.forEach(candle => {
                const candleWorldX = candle.x - worldScrollX;
                
                if (localPlayer.x + localPlayer.width > candleWorldX && 
                    localPlayer.x < candleWorldX + CANDLE_WIDTH) {
                    
                    const candleTopY = getCandleTop(candle);
                    
                    if (localPlayer.y + localPlayer.height >= candleTopY - 5 && 
                        localPlayer.y + localPlayer.height <= candleTopY + 15 &&
                        localPlayer.vy >= 0) {
                        localPlayer.y = candleTopY - localPlayer.height;
                        localPlayer.vy = 0;
                        localPlayer.grounded = true;
                    }
                }
            });

            if ((keys[' '] || keys['ArrowUp']) && localPlayer.grounded) {
                localPlayer.vy = JUMP_FORCE;
                localPlayer.grounded = false;
            }

            // Keep in bounds
            if (localPlayer.x < 50) localPlayer.x = 50;
            if (localPlayer.x > gameCanvas.width - 50) localPlayer.x = gameCanvas.width - 50;

            score = Math.floor(worldScrollX / 10);
            document.getElementById('score').textContent = score;

            // Game over
            if (localPlayer.y > gameCanvas.height + 100) {
                localPlayer.x = 100;
                localPlayer.y = 300;
                localPlayer.vy = 0;
                worldScrollX = 0;
                score = 0;
            }

            if (database && Math.random() < 0.2) {
                update(ref(database, 'players/' + playerId), {
                    x: Math.round(localPlayer.x),
                    y: Math.round(localPlayer.y),
                    color: localPlayer.color,
                    facing: localPlayer.facing,
                    timestamp: Date.now()
                });
            }
        }

        function drawCandles() {
            chartCtx.clearRect(0, 0, chartCanvas.width, chartCanvas.height);
            
            detectedCandles.forEach(candle => {
                const screenX = candle.x - worldScrollX;
                
                if (screenX > -50 && screenX < chartCanvas.width + 50) {
                    const highY = chartCanvas.height - candle.high;
                    const lowY = chartCanvas.height - candle.low;
                    const openY = chartCanvas.height - candle.open;
                    const closeY = chartCanvas.height - candle.close;
                    const bodyTop = Math.min(openY, closeY);
                    const bodyBottom = Math.max(openY, closeY);
                    
                    const color = candle.isGreen ? '#00ff00' : '#ff0000';
                    
                    // Wick
                    chartCtx.fillStyle = color;
                    chartCtx.fillRect(screenX + CANDLE_WIDTH / 2 - 1, highY, 2, lowY - highY);
                    
                    // Body
                    chartCtx.fillStyle = color;
                    chartCtx.fillRect(screenX, bodyTop, CANDLE_WIDTH, Math.max(bodyBottom - bodyTop, 2));
                    
                    // Pixel border
                    chartCtx.strokeStyle = '#000';
                    chartCtx.lineWidth = 1;
                    chartCtx.strokeRect(screenX, bodyTop, CANDLE_WIDTH, Math.max(bodyBottom - bodyTop, 2));
                }
            });
        }

        function drawPlayer(player, isLocal = false) {
            const x = player.x;
            const y = player.y;
            const w = player.width;
            const h = player.height;
            
            // Body
            ctx.fillStyle = player.color;
            ctx.fillRect(x, y, w, h);
            
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, w, h);
            
            // Eyes
            ctx.fillStyle = '#fff';
            if (player.facing === 1) {
                ctx.fillRect(x + 8, y + 4, 4, 4);
            } else {
                ctx.fillRect(x + 4, y + 4, 4, 4);
            }
            
            ctx.fillStyle = '#000';
            if (player.facing === 1) {
                ctx.fillRect(x + 10, y + 5, 2, 2);
            } else {
                ctx.fillRect(x + 4, y + 5, 2, 2);
            }

            // Hat
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(x + 2, y - 4, w - 4, 4);
            ctx.fillRect(x + 4, y - 6, w - 8, 2);

            if (isLocal) {
                ctx.fillStyle = '#ffeb3b';
                ctx.font = '8px "Press Start 2P"';
                ctx.fillText('P1', x - 2, y - 8);
            }
        }

        function gameLoop() {
            // Clear game canvas
            ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
            
            drawCandles();
            updatePlayer();
            drawPlayer(localPlayer, true);

            players.forEach((player, id) => {
                if (id !== playerId) {
                    drawPlayer(player);
                }
            });

            requestAnimationFrame(gameLoop);
        }

        if (database) {
            const playersRef = ref(database, 'players');
            const playerRef = ref(database, 'players/' + playerId);
            
            onDisconnect(playerRef).remove();
            
            onValue(playersRef, (snapshot) => {
                const data = snapshot.val();
                players.clear();
                let count = 0;
                
                if (data) {
                    Object.keys(data).forEach(id => {
                        const player = data[id];
                        if (Date.now() - player.timestamp < 10000) {
                            players.set(id, player);
                            count++;
                        }
                    });
                }
                
                document.getElementById('count').textContent = count;
            });

            window.addEventListener('beforeunload', () => {
                remove(playerRef);
            });
        }

        gameLoop();
    </script>
</body>
</html>
