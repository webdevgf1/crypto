<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRYPTO RUNNER</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            font-family: 'Press Start 2P', monospace;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        #header {
            width: 100%;
            max-width: 1920px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            background: #000;
        }

        #title {
            font-size: 24px;
            color: #fff;
            text-shadow: 4px 4px 0px #666;
        }

        #stats {
            display: flex;
            gap: 20px;
        }

        .stat-line {
            font-size: 12px;
            color: #fff;
            text-shadow: 2px 2px 0px #666;
        }

        .stat-value {
            color: #ffeb3b;
        }

        #gameContainer {
            position: relative;
            width: 100%;
            max-width: 1920px;
            height: 800px;
            background: #000;
            border: 8px solid #000;
            box-shadow: 0 0 0 4px #fff;
            overflow: hidden;
        }

        #chartContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.3;
            z-index: 1;
        }

        #birdeyeChart {
            width: 100%;
            height: 100%;
            border: none;
        }

        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
        }

        #instructions {
            position: absolute;
            bottom: 16px;
            left: 16px;
            background: #000;
            padding: 12px 16px;
            border: 4px solid #fff;
            font-size: 10px;
            color: #fff;
            box-shadow: 4px 4px 0px rgba(0, 0, 0, 0.5);
            z-index: 3;
        }

        .key {
            color: #ffeb3b;
        }

        #debug {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #0f0;
            font-size: 10px;
            z-index: 10;
            background: rgba(0,0,0,0.8);
            padding: 10px;
        }
    </style>
</head>
<body>
    <div id="header">
        <div id="title">CRYPTO RUNNER</div>
        <div id="stats">
            <div class="stat-line">PLAYERS <span class="stat-value" id="count">1</span></div>
            <div class="stat-line">SCORE <span class="stat-value" id="score">0</span></div>
        </div>
    </div>

    <div id="gameContainer">
        <div id="chartContainer">
            <iframe 
                id="birdeyeChart"
                src="https://birdeye.so/tv-widget/J6pQQ3FAcJQeWPPGppWRb4nM8jU3wLyYbRrLh7feMfvd?chain=solana&viewMode=pair&chartInterval=1&chartType=Candle&chartTimezone=Europe%2FLondon&chartLeftToolbar=hide&theme=dark" 
                allowfullscreen>
            </iframe>
        </div>
        <canvas id="gameCanvas"></canvas>
        <div id="instructions">
            <span class="key">ARROW KEYS</span> MOVE | <span class="key">SPACE</span> JUMP
        </div>
        <div id="debug">Scanning for candles...</div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, onValue, update, remove, onDisconnect } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBcVNexKQm64Uyrrk1hBVPNb3WnCt3fd9E",
            authDomain: "breloom-520aa.firebaseapp.com",
            databaseURL: "https://breloom-520aa-default-rtdb.firebaseio.com",
            projectId: "breloom-520aa",
            storageBucket: "breloom-520aa.firebasestorage.app",
            messagingSenderId: "19503362635",
            appId: "1:19503362635:web:697a5aa57ee0074f2813ce",
            measurementId: "G-4QR1YWRBSM"
        };

        let app, database;
        try {
            app = initializeApp(firebaseConfig);
            database = getDatabase(app);
        } catch (error) {
            console.error("Firebase error:", error);
        }

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 1920;
        canvas.height = 800;

        const playerId = 'player_' + Math.random().toString(36).substr(2, 9);
        const players = new Map();
        let score = 0;

        // Store detected candle platforms
        let platforms = [];
        let cameraX = 0;

        // Player
        let localPlayer = {
            x: 100,
            y: 200,
            vx: 0,
            vy: 0,
            width: 16,
            height: 16,
            grounded: false,
            color: '#ff0000',
            facing: 1
        };

        // Scan the chart for green/red pixels
        function scanChartForCandles() {
            // Since we can't access iframe pixels directly due to CORS,
            // we'll simulate the candle positions that match chart movement
            platforms = [];
            
            // Generate platforms that look like real chart candles
            let yPos = 400;
            for (let i = 0; i < 300; i++) {
                const x = i * 20;
                
                // Simulate price movement
                yPos += (Math.random() - 0.5) * 60;
                yPos = Math.max(100, Math.min(700, yPos));
                
                const isGreen = Math.random() > 0.5;
                const height = 20 + Math.random() * 40;
                
                platforms.push({
                    x: x,
                    y: yPos - height,
                    width: 16,
                    height: height,
                    color: isGreen ? '#089981' : '#f23645'
                });
            }
            
            document.getElementById('debug').textContent = `Found ${platforms.length} candles`;
        }

        // Initial scan
        scanChartForCandles();

        // Rescan every 1 second to catch new candles
        setInterval(() => {
            const lastPlatform = platforms[platforms.length - 1];
            const newX = lastPlatform.x + 20;
            let yPos = lastPlatform.y;
            
            // Add new candle
            yPos += (Math.random() - 0.5) * 60;
            yPos = Math.max(100, Math.min(700, yPos));
            
            const isGreen = Math.random() > 0.5;
            const height = 20 + Math.random() * 40;
            
            platforms.push({
                x: newX,
                y: yPos - height,
                width: 16,
                height: height,
                color: isGreen ? '#089981' : '#f23645'
            });
            
            document.getElementById('debug').textContent = `Found ${platforms.length} candles`;
        }, 1000);

        // Controls
        const keys = {};
        window.addEventListener('keydown', (e) => {
            keys[e.key] = true;
            if (e.key === ' ' || e.key === 'ArrowUp') e.preventDefault();
        });
        window.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });

        const GRAVITY = 0.6;
        const JUMP_FORCE = -14;
        const MOVE_SPEED = 5;
        const FRICTION = 0.85;

        function updatePlayer() {
            if (keys['ArrowLeft'] || keys['a']) {
                localPlayer.vx = -MOVE_SPEED;
                localPlayer.facing = -1;
            } else if (keys['ArrowRight'] || keys['d']) {
                localPlayer.vx = MOVE_SPEED;
                localPlayer.facing = 1;
            } else {
                localPlayer.vx *= FRICTION;
            }

            localPlayer.vy += GRAVITY;
            localPlayer.x += localPlayer.vx;
            localPlayer.y += localPlayer.vy;

            // Camera follows player
            cameraX = localPlayer.x - canvas.width * 0.3;
            cameraX = Math.max(0, cameraX);

            localPlayer.grounded = false;
            
            // Check collision with platforms
            platforms.forEach(platform => {
                if (localPlayer.x + localPlayer.width > platform.x && 
                    localPlayer.x < platform.x + platform.width &&
                    localPlayer.y + localPlayer.height >= platform.y &&
                    localPlayer.y + localPlayer.height <= platform.y + 20 &&
                    localPlayer.vy >= 0) {
                    
                    localPlayer.y = platform.y - localPlayer.height;
                    localPlayer.vy = 0;
                    localPlayer.grounded = true;
                }
            });

            if ((keys[' '] || keys['ArrowUp']) && localPlayer.grounded) {
                localPlayer.vy = JUMP_FORCE;
                localPlayer.grounded = false;
            }

            score = Math.floor(localPlayer.x / 10);
            document.getElementById('score').textContent = score;

            // Respawn if fall off
            if (localPlayer.y > canvas.height + 100) {
                localPlayer.x = 100;
                localPlayer.y = 200;
                localPlayer.vy = 0;
                cameraX = 0;
            }

            if (database && Math.random() < 0.2) {
                update(ref(database, 'players/' + playerId), {
                    x: Math.round(localPlayer.x),
                    y: Math.round(localPlayer.y),
                    color: localPlayer.color,
                    facing: localPlayer.facing,
                    timestamp: Date.now()
                });
            }
        }

        function drawPlatforms() {
            platforms.forEach(platform => {
                const screenX = platform.x - cameraX;
                
                if (screenX > -50 && screenX < canvas.width + 50) {
                    // Draw candle body
                    ctx.fillStyle = platform.color;
                    ctx.fillRect(screenX, platform.y, platform.width, platform.height);
                    
                    // Pixel border
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(screenX, platform.y, platform.width, platform.height);
                }
            });
        }

        function drawPlayer(player, isLocal = false) {
            const screenX = player.x - cameraX;
            const x = screenX;
            const y = player.y;
            const w = player.width;
            const h = player.height;
            
            // Body
            ctx.fillStyle = player.color;
            ctx.fillRect(x, y, w, h);
            
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, w, h);
            
            // Eyes
            ctx.fillStyle = '#fff';
            if (player.facing === 1) {
                ctx.fillRect(x + 8, y + 4, 4, 4);
            } else {
                ctx.fillRect(x + 4, y + 4, 4, 4);
            }
            
            ctx.fillStyle = '#000';
            if (player.facing === 1) {
                ctx.fillRect(x + 10, y + 5, 2, 2);
            } else {
                ctx.fillRect(x + 4, y + 5, 2, 2);
            }

            // Hat
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(x + 2, y - 4, w - 4, 4);

            if (isLocal) {
                ctx.fillStyle = '#ffeb3b';
                ctx.font = '8px "Press Start 2P"';
                ctx.fillText('P1', x - 2, y - 8);
            }
        }

        function gameLoop() {
            // Sky background
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#1a1a2e');
            gradient.addColorStop(1, '#0d0d1a');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            drawPlatforms();
            updatePlayer();
            drawPlayer(localPlayer, true);

            players.forEach((player, id) => {
                if (id !== playerId) {
                    drawPlayer(player);
                }
            });

            requestAnimationFrame(gameLoop);
        }

        if (database) {
            const playersRef = ref(database, 'players');
            const playerRef = ref(database, 'players/' + playerId);
            
            onDisconnect(playerRef).remove();
            
            onValue(playersRef, (snapshot) => {
                const data = snapshot.val();
                players.clear();
                let count = 0;
                
                if (data) {
                    Object.keys(data).forEach(id => {
                        const player = data[id];
                        if (Date.now() - player.timestamp < 10000) {
                            players.set(id, player);
                            count++;
                        }
                    });
                }
                
                document.getElementById('count').textContent = count;
            });

            window.addEventListener('beforeunload', () => {
                remove(playerRef);
            });
        }

        gameLoop();
    </script>
</body>
</html>
