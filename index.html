<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRYPTO RUNNER</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #0d0d1a;
            font-family: 'Press Start 2P', monospace;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        #header {
            width: 100%;
            max-width: 1920px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            background: #0d0d1a;
        }

        #title {
            font-size: 24px;
            color: #fff;
            text-shadow: 4px 4px 0px #666;
        }

        #stats {
            display: flex;
            gap: 20px;
        }

        .stat-line {
            font-size: 12px;
            color: #fff;
            text-shadow: 2px 2px 0px #666;
        }

        .stat-value {
            color: #ffeb3b;
        }

        #gameContainer {
            position: relative;
            width: 100%;
            max-width: 1920px;
            height: 800px;
            background: #131722;
            border: 8px solid #000;
            box-shadow: 0 0 0 4px #2a2e39;
            overflow: hidden;
        }

        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
        }

        #minimap {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 250px;
            height: 150px;
            background: rgba(19, 23, 34, 0.95);
            border: 3px solid #2a2e39;
            border-radius: 8px;
            overflow: hidden;
            z-index: 10;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #minimap.expanded {
            width: 500px;
            height: 300px;
        }

        #minimapCanvas {
            width: 100%;
            height: 100%;
        }

        #minimapLabel {
            position: absolute;
            top: 5px;
            left: 8px;
            font-size: 8px;
            color: #fff;
            pointer-events: none;
        }

        #instructions {
            position: absolute;
            bottom: 16px;
            left: 16px;
            background: rgba(0, 0, 0, 0.9);
            padding: 12px 16px;
            border: 4px solid #2a2e39;
            font-size: 10px;
            color: #fff;
            box-shadow: 4px 4px 0px rgba(0, 0, 0, 0.5);
            z-index: 3;
            border-radius: 4px;
        }

        .key {
            color: #ffeb3b;
        }
    </style>
</head>
<body>
    <div id="header">
        <div id="title">CRYPTO RUNNER</div>
        <div id="stats">
            <div class="stat-line">PLAYERS <span class="stat-value" id="count">1</span></div>
            <div class="stat-line">DISTANCE <span class="stat-value" id="score">0</span>m</div>
        </div>
    </div>

    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        <div id="minimap">
            <canvas id="minimapCanvas"></canvas>
            <div id="minimapLabel">MAP - CLICK TO EXPAND</div>
        </div>
        <div id="instructions">
            <span class="key">ARROW KEYS</span> MOVE | <span class="key">SPACE</span> JUMP
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, onValue, update, remove, onDisconnect } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBcVNexKQm64Uyrrk1hBVPNb3WnCt3fd9E",
            authDomain: "breloom-520aa.firebaseapp.com",
            databaseURL: "https://breloom-520aa-default-rtdb.firebaseio.com",
            projectId: "breloom-520aa",
            storageBucket: "breloom-520aa.firebasestorage.app",
            messagingSenderId: "19503362635",
            appId: "1:19503362635:web:697a5aa57ee0074f2813ce",
            measurementId: "G-4QR1YWRBSM"
        };

        let app, database;
        try {
            app = initializeApp(firebaseConfig);
            database = getDatabase(app);
        } catch (error) {
            console.error("Firebase error:", error);
        }

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 1920;
        canvas.height = 800;

        const minimapCanvas = document.getElementById('minimapCanvas');
        const minimapCtx = minimapCanvas.getContext('2d');
        minimapCanvas.width = 250;
        minimapCanvas.height = 150;

        const minimapEl = document.getElementById('minimap');
        let minimapExpanded = false;
        
        minimapEl.addEventListener('click', () => {
            minimapExpanded = !minimapExpanded;
            minimapEl.classList.toggle('expanded');
            if (minimapExpanded) {
                minimapCanvas.width = 500;
                minimapCanvas.height = 300;
            } else {
                minimapCanvas.width = 250;
                minimapCanvas.height = 150;
            }
        });

        const playerId = 'player_' + Math.random().toString(36).substr(2, 9);
        const players = new Map();
        let score = 0;

        // Store platforms
        let platforms = [];
        let cameraX = 0;

        const CANDLE_WIDTH = 14;
        const CANDLE_GAP = 8;
        const CANDLE_SPACING = CANDLE_WIDTH + CANDLE_GAP;

        // Player
        let localPlayer = {
            x: 100,
            y: 200,
            vx: 0,
            vy: 0,
            width: 16,
            height: 16,
            grounded: false,
            color: '#ff0000',
            facing: 1
        };

        // Generate initial platforms with realistic price action
        function generateInitialPlatforms() {
            platforms = [];
            let price = 400;
            let trend = 0;
            
            for (let i = 0; i < 300; i++) {
                const x = i * CANDLE_SPACING;
                
                // More realistic price movement
                trend += (Math.random() - 0.5) * 0.5;
                trend *= 0.95;
                
                const volatility = 30 + Math.random() * 40;
                price += trend * 10 + (Math.random() - 0.5) * volatility;
                price = Math.max(150, Math.min(650, price));
                
                const candleHeight = 20 + Math.random() * 50;
                const isGreen = Math.random() > 0.5;
                
                platforms.push({
                    x: x,
                    y: price - candleHeight / 2,
                    width: CANDLE_WIDTH,
                    height: candleHeight,
                    color: isGreen ? '#089981' : '#f23645',
                    isGreen: isGreen
                });
            }
        }

        generateInitialPlatforms();

        // Add new candles that follow the trend
        setInterval(() => {
            const lastPlatform = platforms[platforms.length - 1];
            const secondLast = platforms[platforms.length - 2];
            
            // Follow the trend from previous candles
            const trend = lastPlatform.y - secondLast.y;
            const newX = lastPlatform.x + CANDLE_SPACING;
            
            let newY = lastPlatform.y + trend * 0.7 + (Math.random() - 0.5) * 40;
            newY = Math.max(150, Math.min(650, newY));
            
            const candleHeight = 20 + Math.random() * 50;
            const isGreen = newY < lastPlatform.y;
            
            platforms.push({
                x: newX,
                y: newY,
                width: CANDLE_WIDTH,
                height: candleHeight,
                color: isGreen ? '#089981' : '#f23645',
                isGreen: isGreen
            });
        }, 1500);

        // Controls
        const keys = {};
        window.addEventListener('keydown', (e) => {
            keys[e.key] = true;
            if (e.key === ' ' || e.key === 'ArrowUp') e.preventDefault();
        });
        window.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });

        const GRAVITY = 0.6;
        const JUMP_FORCE = -14;
        const MOVE_SPEED = 5;
        const FRICTION = 0.85;

        function updatePlayer() {
            if (keys['ArrowLeft'] || keys['a']) {
                localPlayer.vx = -MOVE_SPEED;
                localPlayer.facing = -1;
            } else if (keys['ArrowRight'] || keys['d']) {
                localPlayer.vx = MOVE_SPEED;
                localPlayer.facing = 1;
            } else {
                localPlayer.vx *= FRICTION;
            }

            localPlayer.vy += GRAVITY;
            localPlayer.x += localPlayer.vx;
            localPlayer.y += localPlayer.vy;

            // Camera follows player
            cameraX = localPlayer.x - canvas.width * 0.3;
            cameraX = Math.max(0, cameraX);

            localPlayer.grounded = false;
            
            // Check collision with platforms
            platforms.forEach(platform => {
                if (localPlayer.x + localPlayer.width > platform.x && 
                    localPlayer.x < platform.x + platform.width &&
                    localPlayer.y + localPlayer.height >= platform.y &&
                    localPlayer.y + localPlayer.height <= platform.y + 20 &&
                    localPlayer.vy >= 0) {
                    
                    localPlayer.y = platform.y - localPlayer.height;
                    localPlayer.vy = 0;
                    localPlayer.grounded = true;
                }
            });

            if ((keys[' '] || keys['ArrowUp']) && localPlayer.grounded) {
                localPlayer.vy = JUMP_FORCE;
                localPlayer.grounded = false;
            }

            score = Math.floor(localPlayer.x / 10);
            document.getElementById('score').textContent = score;

            // Respawn if fall off
            if (localPlayer.y > canvas.height + 100) {
                localPlayer.x = 100;
                localPlayer.y = 200;
                localPlayer.vy = 0;
                cameraX = 0;
            }

            if (database && Math.random() < 0.2) {
                update(ref(database, 'players/' + playerId), {
                    x: Math.round(localPlayer.x),
                    y: Math.round(localPlayer.y),
                    color: localPlayer.color,
                    facing: localPlayer.facing,
                    timestamp: Date.now()
                });
            }
        }

        function drawGrid() {
            // Vertical grid lines
            ctx.strokeStyle = 'rgba(42, 46, 57, 0.5)';
            ctx.lineWidth = 1;
            
            const startX = Math.floor(cameraX / 100) * 100;
            for (let x = startX; x < cameraX + canvas.width; x += 100) {
                const screenX = x - cameraX;
                ctx.beginPath();
                ctx.moveTo(screenX, 0);
                ctx.lineTo(screenX, canvas.height);
                ctx.stroke();
            }
            
            // Horizontal grid lines
            for (let y = 0; y < canvas.height; y += 100) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
        }

        function drawPlatforms() {
            platforms.forEach(platform => {
                const screenX = platform.x - cameraX;
                
                if (screenX > -50 && screenX < canvas.width + 50) {
                    // Candle wick (thin line)
                    ctx.fillStyle = platform.color;
                    ctx.fillRect(screenX + platform.width / 2 - 1, platform.y - 10, 2, platform.height + 20);
                    
                    // Candle body
                    ctx.fillStyle = platform.color;
                    ctx.fillRect(screenX, platform.y, platform.width, platform.height);
                    
                    // Border for depth
                    ctx.strokeStyle = platform.isGreen ? '#0a7a6a' : '#d13838';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(screenX, platform.y, platform.width, platform.height);
                }
            });
        }

        function drawPlayer(player, isLocal = false) {
            const screenX = player.x - cameraX;
            const x = screenX;
            const y = player.y;
            const w = player.width;
            const h = player.height;
            
            // Body
            ctx.fillStyle = player.color;
            ctx.fillRect(x, y, w, h);
            
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, w, h);
            
            // Eyes
            ctx.fillStyle = '#fff';
            if (player.facing === 1) {
                ctx.fillRect(x + 8, y + 4, 4, 4);
            } else {
                ctx.fillRect(x + 4, y + 4, 4, 4);
            }
            
            ctx.fillStyle = '#000';
            if (player.facing === 1) {
                ctx.fillRect(x + 10, y + 5, 2, 2);
            } else {
                ctx.fillRect(x + 4, y + 5, 2, 2);
            }

            // Hat
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(x + 2, y - 4, w - 4, 4);

            if (isLocal) {
                ctx.fillStyle = '#ffeb3b';
                ctx.font = '8px "Press Start 2P"';
                ctx.fillText('P1', x - 2, y - 8);
            }
        }

        function drawMinimap() {
            minimapCtx.fillStyle = '#131722';
            minimapCtx.fillRect(0, 0, minimapCanvas.width, minimapCanvas.height);
            
            const scale = minimapExpanded ? 0.1 : 0.05;
            const offsetX = minimapExpanded ? 250 : 125;
            
            // Draw candles on minimap
            platforms.forEach(platform => {
                const mx = (platform.x - cameraX + offsetX) * scale;
                const my = platform.y * scale;
                
                if (mx > 0 && mx < minimapCanvas.width) {
                    minimapCtx.fillStyle = platform.color;
                    minimapCtx.fillRect(mx, my * 0.3, 2, 3);
                }
            });
            
            // Draw player position
            const playerMapX = (localPlayer.x - cameraX + offsetX) * scale;
            const playerMapY = localPlayer.y * scale * 0.3;
            
            // Yellow dot for player
            minimapCtx.fillStyle = '#ffeb3b';
            minimapCtx.beginPath();
            minimapCtx.arc(playerMapX, playerMapY, 4, 0, Math.PI * 2);
            minimapCtx.fill();
            
            // Red border
            minimapCtx.strokeStyle = '#ff0000';
            minimapCtx.lineWidth = 2;
            minimapCtx.stroke();
        }

        function gameLoop() {
            // Background
            ctx.fillStyle = '#131722';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            drawGrid();
            drawPlatforms();
            updatePlayer();
            drawPlayer(localPlayer, true);

            players.forEach((player, id) => {
                if (id !== playerId) {
                    drawPlayer(player);
                }
            });

            drawMinimap();

            requestAnimationFrame(gameLoop);
        }

        if (database) {
            const playersRef = ref(database, 'players');
            const playerRef = ref(database, 'players/' + playerId);
            
            onDisconnect(playerRef).remove();
            
            onValue(playersRef, (snapshot) => {
                const data = snapshot.val();
                players.clear();
                let count = 0;
                
                if (data) {
                    Object.keys(data).forEach(id => {
                        const player = data[id];
                        if (Date.now() - player.timestamp < 10000) {
                            players.set(id, player);
                            count++;
                        }
                    });
                }
                
                document.getElementById('count').textContent = count;
            });

            window.addEventListener('beforeunload', () => {
                remove(playerRef);
            });
        }

        gameLoop();
    </script>
</body>
</html>
